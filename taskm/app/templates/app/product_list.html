{% extends 'base.html' %}

{% block title %}–¢–æ–≤–∞—Ä–∏ | –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥–∞–∂—ñ–≤{% endblock %}

{% block content %}
<div class="header">
    <h1>–¢–æ–≤–∞—Ä–∏</h1>
   <a href="javascript:void(0);" class="btn" id="add-product-btn">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</a>
</div>

<div id="product-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span id="close-btn" class="close">&times;</span>
        <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</h3>
        <form id="product-form" method="POST" action="{% url 'add_product' %}">
            {% csrf_token %}
            <div>
                <label for="name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div>
                <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                <input type="number" id="quantity" name="quantity" required>
            </div>
            <div>
                <label for="price">–¶—ñ–Ω–∞</label>
                <input type="number" id="price" name="price" step="0.01" required>
            </div>
            <div style="margin-top: 14px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                <label for="active" style="margin: 0;">–ê–∫—Ç–∏–≤–Ω–∏–π</label>
                <input type="checkbox" id="active" name="active">
            </div>
            <div style="margin-top: 20px; margin-bottom: 14px; ">
                <button type="submit" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" class="btn btn-secondary" id="cancel-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É -->
<div id="productchange-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span id="closechange-btn" class="close">&times;</span>
        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä</h3>
        <form id="productchange-form" method="POST" action="{% url 'edit_product' %}">
            {% csrf_token %}
            <input type="hidden" id="product-id" name="product_id">
            <div>
                <label for="namechange">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="namechange" name="name" required>
            </div>
            <div>
                <label for="quantitychange">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                <input type="number" id="quantitychange" name="quantity" required>
            </div>
            <div>
                <label for="pricechange">–¶—ñ–Ω–∞</label>
                <input type="number" id="pricechange" name="price" step="0.01" required>
            </div>
            <div style="margin-top: 14px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;">
                <label for="activechange" style="margin: 0;">–ê–∫—Ç–∏–≤–Ω–∏–π</label>
                <input type="checkbox" id="activechange" name="active">
            </div>
            <div style="margin-top: 20px; margin-bottom: 14px;">
                <button type="submit" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" class="btn btn-secondary" id="cancelchange-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </form>
    </div>
</div>


<div class="card">
    <table>
        <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î—ñ—ó</th>
        </tr>
        </thead>
        <tbody>
        {% for product in products %}
        <tr class="{% if product.quantity <= 5 %}low-stock-critical{% elif product.quantity <= 10 %}low-stock-warning{% endif %}">
            <td>{{ product.name }}</td>
            <td>{{ product.price }} –≥—Ä–Ω</td>
            <td>{{ product.quantity }} —à—Ç.</td>
            <td>
                    <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;
                        {% if product.active %}
                            background-color: #e3f9e5; color: #1e7e34;
                        {% else %}
                            background-color: #f8d7da; color: #721c24;
                        {% endif %}
                    ">
                        {% if product.active %}–ê–∫—Ç–∏–≤–Ω–∏–π{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π{% endif %}
                    </span>
            </td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <a href="javascript:void(0);" class="btn btn-secondary" id="change-product-btn"
                       data-product-id="{{ product.id }}"
                       data-product-name="{{ product.name }}"
                       data-product-quantity="{{ product.quantity }}"
                       data-product-price="{{ product.price }}"
                       data-product-active="{{ product.active }}"
                       style="padding: 4px 8px; font-size: 0.9rem;">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" style="text-align: center;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ç–æ–≤–∞—Ä–∏</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="margin-top: 30px; display: flex; flex-wrap: wrap; gap: 20px; align-items: stretch;">
    <!-- Low stock products -->
    <div style="flex: 1; min-width: 300px; background-color: var(--gray-100); border-radius: 8px; padding: 15px;">
        <h2 style="margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--gray-300);">
            <span style="color: var(--orange-600);">‚ö†Ô∏è</span> –¢–æ–≤–∞—Ä–∏ –∑ –º–∞–ª–∏–º –∑–∞–ø–∞—Å–æ–º
        </h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% for product in products %}
            {% if product.quantity <= 10 %}
            <div style="background-color: white; padding: 10px; border-radius: 4px;
                    border-left: 4px solid {% if product.quantity <= 5 %}var(--danger){% else %}var(--warning){% endif %};">
                <div style="font-weight: bold;">{{ product.name }}</div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <div>–ó–∞–ª–∏—à–æ–∫: <strong>{{ product.quantity }} —à—Ç.</strong></div>
                    <div>{{ product.price }} –≥—Ä–Ω</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% with low_stock_count=0 %}
            {% for product in products %}
            {% if product.quantity <= 10 %}
            {% with low_stock_count=1 %}{% endwith %}
            {% endif %}
            {% endfor %}

            {% if low_stock_count == 0 %}
            <div style="text-align: center; padding: 20px; color: var(--gray-600);">
                –ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –º–∞–ª–∏–º –∑–∞–ø–∞—Å–æ–º
            </div>
            {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- Active vs Inactive statistics -->
    <div style="flex: 1; min-width: 300px; background-color: var(--gray-100); border-radius: 8px; padding: 15px;">
        <h2 style="margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--gray-300);">
            <span style="color: var(--info);">üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä—ñ–≤
        </h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Total products -->
            <div style="background-color: white; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.9rem; color: var(--gray-600);">–í—Å—å–æ–≥–æ —Ç–æ–≤–∞—Ä—ñ–≤</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--gray-800);">{{ products|length }}</div>
            </div>

            <!-- Active products -->
            <div style="background-color: white; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.9rem; color: var(--gray-600);">–ê–∫—Ç–∏–≤–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--success);">
                    {% with active_count=0 %}
                    {% for product in products %}
                    {% if product.active %}
                    {% with active_count=active_count|add:1 %}{% endwith %}
                    {% endif %}
                    {% endfor %}

                    {{ active_count }}
                    <div style="font-size: 0.9rem; color: var(--gray-600);">
                        {% if products|length > 0 %}
                        {{ active_count|floatformat:0 }}%
                        {% else %}
                        0%
                        {% endif %}
                    </div>
                    {% endwith %}
                </div>
            </div>

            <!-- Low stock products -->
            <div style="background-color: white; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 0.9rem; color: var(--gray-600);">–¢–æ–≤–∞—Ä—ñ–≤ –∑ –º–∞–ª–∏–º –∑–∞–ø–∞—Å–æ–º</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--warning);">
                    {% with low_stock_count=0 %}
                    {% for product in products %}
                    {% if product.quantity <= 10 %}
                    {% with low_stock_count=low_stock_count|add:1 %}{% endwith %}
                    {% endif %}
                    {% endfor %}

                    {{ low_stock_count }}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
        // –û—Ç—Ä–∏–º—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏
    const modal = document.getElementById("product-modal");
    const btn = document.getElementById("add-product-btn");
    const span = document.getElementById("close-btn");
    const cancelBtn = document.getElementById("cancel-btn");

    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫
    span.onclick = function() {
        modal.style.display = "none";
    }

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è
    cancelBtn.onclick = function() {
        modal.style.display = "none";
    }

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –ø–æ–∑–∞ –π–æ–≥–æ –º–µ–∂–∞–º–∏
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    document.querySelectorAll('#change-product-btn').forEach(button => {
    button.onclick = function() {
            const productId = this.getAttribute('data-product-id');
            const productName = this.getAttribute('data-product-name');
            const productQuantity = this.getAttribute('data-product-quantity');
            const productPrice = this.getAttribute('data-product-price');
            const productActive = this.getAttribute('data-product-active') === 'True'; // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç—Ä–æ–∫—É –Ω–∞ –±—É–ª–µ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
            document.getElementById('product-id').value = productId;
            document.getElementById('namechange').value = productName;
            document.getElementById('quantitychange').value = productQuantity;
            document.getElementById('pricechange').value = productPrice;
            document.getElementById('activechange').checked = productActive;

            // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            document.getElementById('productchange-modal').style.display = 'block';
        };
    });

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫
    document.getElementById('closechange-btn').onclick = function() {
        document.getElementById('productchange-modal').style.display = 'none';
    }

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è
    document.getElementById('cancelchange-btn').onclick = function() {
        document.getElementById('productchange-modal').style.display = 'none';
    }

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –ø–æ–∑–∞ –π–æ–≥–æ –º–µ–∂–∞–º–∏
    window.onclick = function(event) {
        const modal = document.getElementById('productchange-modal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>>
{% endblock %}